<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Timer v15 (Fixed)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #00ff9d;
            --warn-bg: #b34700;
            --warn-text: #ffffff;
            --end-bg: #cc0000;
            --end-text: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        #time-display {
            font-size: 25vw;
            line-height: 1;
            font-weight: 900; 
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: default;
            user-select: none;
            transition: color 0.3s ease;
            pointer-events: none; /* Allows clicks to pass through numbers */
        }

        #ui-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 10;
            padding: 20px;
            border-radius: 12px;
            background: rgba(30,30,30, 0.8);
            backdrop-filter: blur(5px);
        }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .hidden { display: none !important; }

        button {
            font-family: 'Roboto', sans-serif;
            padding: 12px 20px;
            cursor: pointer;
            border: 1px solid #444;
            border-radius: 8px;
            background: #222;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.1s, background 0.2s;
            pointer-events: auto;
        }
        button:active { transform: scale(0.96); }
        button:hover { background: #333; }
        button.primary { background: #00ff9d; color: #111; font-weight: 900; border: none; }
        button.icon-btn { padding: 12px; font-size: 1.2rem; }

        #invite-link-box {
            background: #222;
            padding: 10px 20px;
            border: 1px dashed #555;
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            max-width: 90vw;
            word-break: break-all;
        }

        #settings-panel {
            margin-top: 10px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .theme-dot {
            width: 25px; height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #555;
        }
    </style>
</head>
<body>

    <div id="setup-panel">
        <h1 style="color:var(--text-color); margin-bottom: 30px; font-weight:900;">Shared Timer</h1>
        <button class="primary" onclick="initHost()">Start as Host</button>
        <p id="loading-msg" class="hidden" style="color:#888; margin-top:20px;">Connecting...</p>
    </div>

    <div id="app-wrapper" class="hidden" style="display:flex; flex-direction:column; alignItems:center; width:100%;">
        <div id="time-display">00:00</div>

        <div id="ui-container">
            <div class="controls">
                <button onclick="togglePiP()">ðŸ“º Pop Out</button>
                <button class="icon-btn" onclick="toggleSettings()" title="Settings">ðŸŽ¨</button>
                <button class="icon-btn" id="sound-btn" onclick="toggleSound()" title="Mute/Unmute">ðŸ”Š</button>
            </div>

            <div id="settings-panel" class="hidden">
                <span style="font-size:0.8rem; color:#aaa;">Theme:</span>
                <div class="theme-dot" style="background:#000; border-color:#00ff9d" onclick="setTheme('neon')"></div>
                <div class="theme-dot" style="background:#fff; border-color:#000" onclick="setTheme('light')"></div>
                <div class="theme-dot" style="background:#001f3f; border-color:#7FDBFF" onclick="setTheme('blue')"></div>
            </div>

            <div id="host-controls" class="controls hidden" style="margin-top:10px;">
                <button id="btn-1" onclick="addTime(1)">+1m</button>
                <button id="btn-5" onclick="addTime(5)">+5m</button>
                <button id="btn-10" onclick="addTime(10)">+10m</button>
                <button id="btn-reset" class="primary" onclick="resetTimer()">Reset</button>
            </div>

            <div id="share-area" class="hidden" style="text-align:center; margin-top:15px;">
                <div id="invite-link-box" onclick="copyLink()">ðŸ“‹ Click to Copy Invite Link</div>
                <div style="display:flex; align-items:center; justify-content:center; gap:5px; margin-top:10px;">
                    <div id="conn-dot" style="width:8px; height:8px; background:gray; border-radius:50%;"></div>
                    <span id="status-msg" style="color:#666; font-size:0.8rem;">Initializing...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BROKER = "broker.emqx.io";
        const PORT = 8084;
        let client = null, roomID = "", isHost = false;

        let targetTime = null;
        let soundEnabled = true;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let pipWindow = null;
        let hasWarned = false, hasEnded = false;
        let currentTheme = { bg: '#000000', text: '#00ff9d' };

        const displayEl = document.getElementById('time-display');
        const appWrapper = document.getElementById('app-wrapper');
        const uiContainer = document.getElementById('ui-container');
        const hostControls = document.getElementById('host-controls');

        const urlParams = new URLSearchParams(window.location.search);
        const joinID = urlParams.get('join');

        if (joinID) {
            roomID = joinID;
            document.getElementById('setup-panel').classList.add('hidden');
            appWrapper.classList.remove('hidden');
            hostControls.remove();
            document.getElementById('invite-link-box').innerText = "Viewer Mode";
            connectMQTT(roomID);
        }

        function initHost() {
            document.getElementById('loading-msg').classList.remove('hidden');
            isHost = true;
            roomID = Math.floor(100000 + Math.random() * 900000).toString();
            connectMQTT(roomID, () => {
                document.getElementById('setup-panel').classList.add('hidden');
                appWrapper.classList.remove('hidden');
                hostControls.classList.remove('hidden');
                document.getElementById('share-area').classList.remove('hidden');
                const link = `${window.location.origin}${window.location.pathname}?join=${roomID}`;
                document.getElementById('invite-link-box').dataset.link = link;
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
        }

        function connectMQTT(id, onSuccess) {
            const clientId = (isHost ? "host_" : "view_") + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(BROKER, PORT, "/mqtt", clientId);
            client.onConnectionLost = (o) => {
                updateStatus(false, "Reconnecting...");
                setTimeout(() => connectMQTT(id, onSuccess), 2500);
            };
            client.onMessageArrived = (msg) => {
                try {
                    const data = JSON.parse(msg.payloadString);
                    handleData(data);
                } catch(e) {}
            };
            client.connect({
                useSSL: true,
                onSuccess: () => {
                    updateStatus(true, "Online");
                    client.subscribe(`timerapp/${id}/state`);
                    if(onSuccess) onSuccess();
                },
                onFailure: (e) => {
                    updateStatus(false, "Error: " + e.errorMessage);
                    setTimeout(() => connectMQTT(id, onSuccess), 3000);
                }
            });
        }

        window.publishState = function() {
            if(!isHost || !client || !client.isConnected()) return;
            const msg = new Paho.MQTT.Message(JSON.stringify({ targetTime }));
            msg.destinationName = `timerapp/${roomID}/state`;
            msg.retained = true;
            client.send(msg);
        }

        function handleData(data) {
            if (data.targetTime !== undefined) {
                targetTime = data.targetTime;
                if (targetTime && targetTime > Date.now()) {
                    hasWarned = false; hasEnded = false;
                    applyColor(currentTheme.bg, currentTheme.text);
                }
                updateDisplay();
            }
        }

        window.addTime = function(min) {
            if(!isHost) return;
            const now = Date.now();
            const basis = (targetTime && targetTime > now) ? targetTime : now;
            targetTime = basis + (min * 60000);
            hasWarned = false; hasEnded = false;
            window.publishState();
            updateDisplay();
        }

        window.resetTimer = function() {
            if(!isHost) return;
            targetTime = null;
            hasWarned = false; hasEnded = false;
            applyColor(currentTheme.bg, currentTheme.text);
            window.publishState();
            updateDisplay();
        }

        function updateDisplay() {
            if (!targetTime) { displayEl.innerText = "00:00"; return; }
            const diff = targetTime - Date.now();
            if (diff <= 0) {
                displayEl.innerText = "00:00";
                if (!hasEnded) { hasEnded = true; applyColor('var(--end-bg)', 'var(--end-text)'); playSound('alarm'); }
            } else if (diff <= 60000) {
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                displayEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (!hasWarned) { hasWarned = true; applyColor('var(--warn-bg)', 'var(--warn-text)'); playSound('beep'); }
            } else {
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                displayEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (hasWarned) { hasWarned = false; applyColor(currentTheme.bg, currentTheme.text); }
            }
        }
        setInterval(updateDisplay, 50);

        function updateStatus(connected, txt) {
            document.getElementById('status-msg').innerText = txt;
            document.getElementById('conn-dot').style.background = connected ? '#00ff9d' : '#ff4444';
        }

        window.toggleSettings = () => document.getElementById('settings-panel').classList.toggle('hidden');
        window.toggleSound = () => {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').innerText = soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
            if(soundEnabled && audioCtx.state === 'suspended') audioCtx.resume();
        }
        window.setTheme = (name) => {
            const themes = { neon: { bg: '#000000', text: '#00ff9d' }, light: { bg: '#ffffff', text: '#000000' }, blue: { bg: '#001f3f', text: '#7FDBFF' } };
            currentTheme = themes[name];
            if (!hasWarned && !hasEnded) applyColor(currentTheme.bg, currentTheme.text);
        };
        function applyColor(bg, text) {
            document.body.style.backgroundColor = bg;
            displayEl.style.color = text;
            if (pipWindow) pipWindow.document.body.style.backgroundColor = bg;
        }
        window.copyLink = () => {
            const link = document.getElementById('invite-link-box').dataset.link;
            navigator.clipboard.writeText(link);
            alert("Link copied!");
        }
        function playSound(type) {
            if (!soundEnabled) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'beep') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.setValueAtTime(0, now+0.1); gain.gain.setValueAtTime(0.1, now+0.2); gain.gain.setValueAtTime(0, now+0.3);
                osc.start(now); osc.stop(now+0.4);
            } else if (type === 'alarm') {
                osc.type = 'square'; osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now); gain.gain.setValueAtTime(0, now+0.2); gain.gain.setValueAtTime(0.1, now+0.3); gain.gain.setValueAtTime(0, now+0.5); gain.gain.linearRampToValueAtTime(0, now+1.2);
                osc.start(now); osc.stop(now+1.2);
            }
        }

        // --- 5. POP OUT (FIXED BUTTONS) ---
        window.togglePiP = async () => {
            if (!window.documentPictureInPicture) return alert("Use Chrome/Edge");
            if (pipWindow) { pipWindow.close(); return; }
            pipWindow = await window.documentPictureInPicture.requestWindow({ width: 300, height: 150 });
            
            [...document.head.querySelectorAll('style, link[rel="stylesheet"]')].forEach(el => 
                pipWindow.document.head.appendChild(el.cloneNode(true)));

            const pipStyle = pipWindow.document.createElement('style');
            pipStyle.textContent = `
                body {
                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                    margin: 0; height: 100vh; overflow: hidden; transition: background 0.5s;
                    background-color: ${currentTheme.bg};
                }
                #time-display { 
                    font-size: 40vh !important;
                    pointer-events: none; /* Allows clicks to pass through numbers */
                }
                
                #host-controls {
                    position: fixed; bottom: 0; left: 0; width: 100%;
                    box-sizing: border-box;
                    display: flex !important;
                    justify-content: space-between; /* Spread evenly */
                    gap: 2px; /* Tiny gap */
                    padding: 0;
                    background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
                    opacity: 0.2; transition: opacity 0.2s; z-index: 9999;
                }
                #host-controls:hover { opacity: 1; }
                
                /* BUTTONS FILL WIDTH */
                #host-controls button {
                    pointer-events: auto; 
                    flex: 1; /* Stretch to fill space equally */
                    padding: 10px 0; /* Vertical padding only */
                    font-size: 0.75rem; 
                    border: 1px solid rgba(255,255,255,0.3);
                    background: rgba(50,50,50,0.8);
                    border-radius: 0; /* Square edges for flush fit */
                    margin: 0;
                }
                #host-controls button:hover { background: #00ff9d; color: black; }
            `;
            pipWindow.document.head.appendChild(pipStyle);

            pipWindow.document.body.append(displayEl);

            if(isHost) {
                hostControls.classList.remove('hidden');
                pipWindow.document.body.append(hostControls);
                
                // CRITICAL FIX: Re-attach events in the new window context
                pipWindow.document.getElementById('btn-1').onclick = () => window.addTime(1);
                pipWindow.document.getElementById('btn-5').onclick = () => window.addTime(5);
                pipWindow.document.getElementById('btn-10').onclick = () => window.addTime(10);
                pipWindow.document.getElementById('btn-reset').onclick = () => window.resetTimer();
            }

            pipWindow.addEventListener('pagehide', () => {
                displayEl.style.fontSize = "25vw";
                appWrapper.insertBefore(displayEl, uiContainer);
                if(isHost) {
                    const shareArea = document.getElementById('share-area');
                    uiContainer.insertBefore(hostControls, shareArea);
                }
                pipWindow = null;
            });
        };
    </script>
</body>
</html>
