<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure MQTT Timer (v8)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #00ff9d;
            --warn-bg: #b34700;
            --warn-text: #ffffff;
            --end-bg: #cc0000;
            --end-text: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        #time-display {
            font-size: 25vw;
            line-height: 1;
            font-weight: 900; 
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: default;
            user-select: none;
            transition: color 0.3s ease;
        }

        #ui-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 10;
            padding: 20px;
            border-radius: 12px;
            background: rgba(30,30,30, 0.8);
            backdrop-filter: blur(5px);
        }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .hidden { display: none !important; }

        button {
            font-family: 'Roboto', sans-serif;
            padding: 12px 20px;
            cursor: pointer;
            border: 1px solid #444;
            border-radius: 8px;
            background: #222;
            color: white;
            font-size: 1rem;
            font-weight: 500;
        }
        button:hover { background: #333; }
        button.primary { background: #00ff9d; color: #111; font-weight: 900; border: none; }
        button.icon-btn { padding: 12px; font-size: 1.2rem; }

        #invite-link-box {
            background: #222;
            padding: 10px 20px;
            border: 1px dashed #555;
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        #settings-panel {
            margin-top: 10px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .theme-dot {
            width: 25px; height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #555;
        }
    </style>
</head>
<body>

    <div id="setup-panel">
        <h1 style="color:var(--text-color); margin-bottom: 30px; font-weight:900;">Shared Timer</h1>
        <button class="primary" onclick="initializeHost()">Start New Timer (Host)</button>
        <p id="loading-msg" class="hidden" style="color:#888; margin-top:20px;">Connecting to secure cloud...</p>
    </div>

    <div id="app-wrapper" class="hidden" style="display:flex; flex-direction:column; alignItems:center; width:100%;">
        <div id="time-display">00:00</div>

        <div id="ui-container">
            <div class="controls">
                <button onclick="togglePiP()">ðŸ“º Pop Out</button>
                <button class="icon-btn" onclick="toggleSettings()" title="Settings">ðŸŽ¨</button>
                <button class="icon-btn" id="sound-btn" onclick="toggleSound()" title="Mute/Unmute">ðŸ”Š</button>
            </div>

            <div id="settings-panel" class="hidden">
                <span style="font-size:0.8rem; color:#aaa;">Theme:</span>
                <div class="theme-dot" style="background:#000; border-color:#00ff9d" onclick="setTheme('neon')"></div>
                <div class="theme-dot" style="background:#fff; border-color:#000" onclick="setTheme('light')"></div>
                <div class="theme-dot" style="background:#001f3f; border-color:#7FDBFF" onclick="setTheme('blue')"></div>
            </div>

            <div id="host-controls" class="controls hidden" style="margin-top:10px;">
                <button onclick="addTime(1)">+1m</button>
                <button onclick="addTime(5)">+5m</button>
                <button onclick="addTime(10)">+10m</button>
                <button class="primary" onclick="resetTimer()">Reset</button>
            </div>

            <div id="share-area" class="hidden" style="text-align:center; margin-top:15px;">
                <div id="invite-link-box" onclick="copyLink()">ðŸ“‹ Click to Copy Invite Link</div>
                <p id="status-msg" style="color: #666; font-size: 0.8rem; margin-top: 10px;">Connected Securely (WSS)</p>
            </div>
        </div>
    </div>

    <script>
        // --- MQTT CONFIGURATION ---
        const MQTT_BROKER = "broker.emqx.io";
        const MQTT_PORT = 8084; // Secure WebSocket Port (Firewall Friendly)
        const MQTT_PATH = "/mqtt";
        
        // --- VARIABLES ---
        let client;
        let roomID;
        let targetTime = null;
        let isHost = false;
        let pipWindow = null;
        let soundEnabled = true;
        let hasWarned = false, hasEnded = false;
        
        const displayEl = document.getElementById('time-display');
        const uiContainer = document.getElementById('ui-container');
        const appWrapper = document.getElementById('app-wrapper');
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        // Themes
        const themes = {
            neon: { bg: '#000000', text: '#00ff9d' },
            light: { bg: '#ffffff', text: '#000000' },
            blue: { bg: '#001f3f', text: '#7FDBFF' }
        };
        let currentTheme = themes.neon;

        // --- INIT ---
        const urlParams = new URLSearchParams(window.location.search);
        const joinID = urlParams.get('join');

        if (joinID) {
            // VIEWER MODE
            roomID = joinID;
            document.getElementById('setup-panel').classList.add('hidden');
            appWrapper.classList.remove('hidden');
            document.getElementById('host-controls').remove(); // Remove admin buttons
            document.getElementById('invite-link-box').innerText = "Viewer Mode";
            connectMQTT();
        }

        function initializeHost() {
            // HOST MODE
            document.getElementById('loading-msg').classList.remove('hidden');
            isHost = true;
            // Generate random room ID
            roomID = "timer_" + Math.random().toString(36).substr(2, 9);
            
            connectMQTT(() => {
                document.getElementById('setup-panel').classList.add('hidden');
                appWrapper.classList.remove('hidden');
                document.getElementById('host-controls').classList.remove('hidden');
                document.getElementById('share-area').classList.remove('hidden');
                
                const link = `${window.location.origin}${window.location.pathname}?join=${roomID}`;
                document.getElementById('invite-link-box').dataset.link = link;
                
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
        }

        // --- MQTT CONNECTION ---
        function connectMQTT(onSuccessCallback) {
            const clientId = "client_" + Math.random().toString(36).substr(2, 9);
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_PATH, clientId);

            client.onConnectionLost = (responseObject) => {
                document.getElementById('status-msg').innerText = "Connection Lost. Reconnecting...";
                setTimeout(() => connectMQTT(), 5000);
            };

            client.onMessageArrived = (message) => {
                try {
                    const data = JSON.parse(message.payloadString);
                    handleData(data);
                } catch (e) { console.log("Data error", e); }
            };

            const connectOptions = {
                useSSL: true, // CRITICAL: This bypasses the firewall
                timeout: 3,
                onSuccess: () => {
                    document.getElementById('status-msg').innerText = "Connected Securely";
                    // Subscribe to the specific room topic
                    client.subscribe(roomID);
                    if (onSuccessCallback) onSuccessCallback();
                },
                onFailure: (message) => {
                    document.getElementById('status-msg').innerText = "Connection Failed. Retrying...";
                    setTimeout(() => connectMQTT(onSuccessCallback), 5000);
                }
            };

            client.connect(connectOptions);
        }

        // --- TIMER LOGIC ---
        function handleData(data) {
            if (data.targetTime !== undefined) {
                targetTime = data.targetTime;
                // If adding time, reset warnings
                if (targetTime - Date.now() > 60000) hasWarned = false;
                if (targetTime - Date.now() > 0) hasEnded = false;
            }
            if (data.reset) {
                targetTime = null;
                hasWarned = false; hasEnded = false;
                applyColor(currentTheme.bg, currentTheme.text);
            }
            updateDisplay();
        }

        function addTime(m) {
            if (!isHost) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();

            const now = Date.now();
            const basis = (targetTime && targetTime > now) ? targetTime : now;
            targetTime = basis + (m * 60000);
            
            hasWarned = false; hasEnded = false;
            publish({ targetTime: targetTime });
            updateDisplay();
        }

        function resetTimer() {
            if (!isHost) return;
            targetTime = null;
            publish({ reset: true });
            applyColor(currentTheme.bg, currentTheme.text);
            updateDisplay();
        }

        function publish(data) {
            if (!client || !client.isConnected()) return;
            const message = new Paho.MQTT.Message(JSON.stringify(data));
            message.destinationName = roomID;
            message.retained = true; // CRITICAL: New viewers get the time instantly
            client.send(message);
        }

        function updateDisplay() {
            if (!targetTime) {
                displayEl.innerText = "00:00";
                return;
            }
            const diff = targetTime - Date.now();

            if (diff <= 0) {
                displayEl.innerText = "00:00";
                if (!hasEnded) {
                    hasEnded = true;
                    applyColor('var(--end-bg)', 'var(--end-text)');
                    playSound('alarm');
                }
            } else if (diff <= 60000) {
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                displayEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (!hasWarned) {
                    hasWarned = true;
                    applyColor('var(--warn-bg)', 'var(--warn-text)');
                    playSound('beep');
                }
            } else {
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                displayEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if (hasWarned) {
                    hasWarned = false;
                    applyColor(currentTheme.bg, currentTheme.text);
                }
            }
        }
        setInterval(updateDisplay, 50);

        // --- UTILS ---
        window.toggleSettings = () => {
            document.getElementById('settings-panel').classList.toggle('hidden');
        };

        window.toggleSound = () => {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').innerText = soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
            if (soundEnabled && audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.setTheme = (name) => {
            currentTheme = themes[name];
            if (!hasWarned && !hasEnded) applyColor(currentTheme.bg, currentTheme.text);
        };

        function applyColor(bg, text) {
            document.body.style.backgroundColor = bg;
            displayEl.style.color = text;
            if (pipWindow) pipWindow.document.body.style.backgroundColor = bg;
        }

        function copyLink() {
            navigator.clipboard.writeText(document.getElementById('invite-link-box').dataset.link);
            alert("Link copied!");
        }

        // --- SOUND ENGINE ---
        function playSound(type) {
            if (!soundEnabled) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'beep') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.setValueAtTime(0, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now + 0.2);
                gainNode.gain.setValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.4);
            } else if (type === 'alarm') {
                osc.type = 'square'; 
                osc.frequency.setValueAtTime(600, now); 
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.setValueAtTime(0, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now + 0.3);
                gainNode.gain.setValueAtTime(0, now + 0.5);
                gainNode.gain.setValueAtTime(0.1, now + 0.6);
                gainNode.gain.linearRampToValueAtTime(0, now + 1.2); 
                osc.start(now);
                osc.stop(now + 1.2);
            }
        }

        // --- POP OUT (PiP) ---
        window.togglePiP = async () => {
            if (!('documentPictureInPicture' in window)) return alert("Use Chrome/Edge 116+");
            if (pipWindow) { pipWindow.close(); return; }

            pipWindow = await window.documentPictureInPicture.requestWindow({ width: 300, height: 150 });

            // Copy styles & fonts
            [...document.head.querySelectorAll('style, link[rel="stylesheet"]')].forEach(el => {
                pipWindow.document.head.appendChild(el.cloneNode(true));
            });

            const currentBg = document.body.style.backgroundColor || currentTheme.bg;
            pipWindow.document.body.style.backgroundColor = currentBg;
            Object.assign(pipWindow.document.body.style, {
                display: "flex", alignItems: "center", justifyContent: "center",
                margin: "0", height: "100vh", overflow: "hidden",
                transition: "background-color 0.5s ease"
            });

            pipWindow.document.body.append(displayEl);
            displayEl.style.fontSize = "40vh"; 

            pipWindow.addEventListener('pagehide', () => {
                displayEl.style.fontSize = "25vw";
                appWrapper.insertBefore(displayEl, uiContainer);
                pipWindow = null;
            });
        };
    </script>
</body>
</html>
