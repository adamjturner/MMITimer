<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Timer (Secure MQTT)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;900&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #00ff9d;
            --warn-bg: #b34700;
            --warn-text: #ffffff;
            --end-bg: #cc0000;
            --end-text: #ffffff;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        /* TIMER DISPLAY */
        #time-display {
            font-size: 25vw;
            line-height: 1;
            font-weight: 900; 
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            text-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            cursor: default;
            user-select: none;
            transition: color 0.3s ease;
        }

        /* CONTROLS CONTAINER */
        #ui-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            z-index: 10;
            padding: 20px;
            border-radius: 12px;
            background: rgba(30,30,30, 0.8);
            backdrop-filter: blur(5px);
        }

        .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .hidden { display: none !important; }

        button {
            font-family: 'Roboto', sans-serif;
            padding: 12px 20px;
            cursor: pointer;
            border: 1px solid #444;
            border-radius: 8px;
            background: #222;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        button:hover { background: #333; }
        button.primary { background: #00ff9d; color: #111; font-weight: 900; border: none; }
        button.icon-btn { padding: 12px; font-size: 1.2rem; }

        /* LINK BOX */
        #invite-link-box {
            background: #222;
            padding: 10px 20px;
            border: 1px dashed #555;
            color: #ccc;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            max-width: 90vw;
            word-break: break-all;
        }

        /* THEMES */
        #settings-panel {
            margin-top: 10px;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .theme-dot {
            width: 25px; height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #555;
        }
    </style>
</head>
<body>

    <div id="setup-panel">
        <h1 style="color:var(--text-color); margin-bottom: 30px; font-weight:900;">Shared Timer</h1>
        <button class="primary" onclick="initializeHost()">Start as Host</button>
        <p id="loading-msg" class="hidden" style="color:#888; margin-top:20px;">Establishing secure connection...</p>
    </div>

    <div id="app-wrapper" class="hidden" style="display:flex; flex-direction:column; alignItems:center; width:100%;">
        
        <div id="time-display">00:00</div>

        <div id="ui-container">
            <div class="controls">
                <button onclick="togglePiP()">ðŸ“º Pop Out</button>
                <button class="icon-btn" onclick="toggleSettings()" title="Settings">ðŸŽ¨</button>
                <button class="icon-btn" id="sound-btn" onclick="toggleSound()" title="Mute/Unmute">ðŸ”Š</button>
            </div>

            <div id="settings-panel" class="hidden">
                <span style="font-size:0.8rem; color:#aaa;">Theme:</span>
                <div class="theme-dot" style="background:#000; border-color:#00ff9d" onclick="setTheme('neon')"></div>
                <div class="theme-dot" style="background:#fff; border-color:#000" onclick="setTheme('light')"></div>
                <div class="theme-dot" style="background:#001f3f; border-color:#7FDBFF" onclick="setTheme('blue')"></div>
            </div>

            <div id="host-controls" class="controls hidden" style="margin-top:10px;">
                <button onclick="addTime(1)">+1m</button>
                <button onclick="addTime(5)">+5m</button>
                <button onclick="addTime(10)">+10m</button>
                <button class="primary" onclick="resetTimer()">Reset</button>
            </div>

            <div id="share-area" class="hidden" style="text-align:center; margin-top:15px;">
                <div id="invite-link-box" onclick="copyLink()">ðŸ“‹ Click to Copy Invite Link</div>
                <div style="display:flex; align-items:center; justify-content:center; gap:5px; margin-top:10px;">
                    <div id="conn-dot" style="width:8px; height:8px; background:gray; border-radius:50%;"></div>
                    <span id="status-msg" style="color:#666; font-size:0.8rem;">Connecting...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION (The one that works!) ---
        const MQTT_BROKER = "broker.emqx.io";
        const MQTT_PORT = 8084; // Secure WSS Port
        const MQTT_PATH = "/mqtt";

        // --- VARIABLES ---
        let client = null;
        let roomID = "";
        let isHost = false;
        let targetTime = null;
        
        // Anti-Crash & Audio
        let wakeLock = null;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = true;

        // Visual States
        let hasWarned = false, hasEnded = false;
        let pipWindow = null;
        let themes = {
            neon: { bg: '#000000', text: '#00ff9d' },
            light: { bg: '#ffffff', text: '#000000' },
            blue: { bg: '#001f3f', text: '#7FDBFF' }
        };
        let currentTheme = themes.neon;

        // DOM Elements
        const displayEl = document.getElementById('time-display');
        const appWrapper = document.getElementById('app-wrapper');
        const uiContainer = document.getElementById('ui-container');

        // --- 1. INITIALIZATION ---
        const urlParams = new URLSearchParams(window.location.search);
        const joinID = urlParams.get('join');

        if (joinID) {
            // VIEWER MODE
            roomID = joinID;
            document.getElementById('setup-panel').classList.add('hidden');
            appWrapper.classList.remove('hidden');
            document.getElementById('host-controls').remove(); // Remove admin buttons
            document.getElementById('invite-link-box').innerText = "Connected as Viewer";
            connectMQTT();
        }

        async function initializeHost() {
            // HOST MODE
            document.getElementById('loading-msg').classList.remove('hidden');
            isHost = true;
            
            // 1. Generate Room ID
            roomID = "tmr_" + Math.random().toString(36).substr(2, 6);
            
            // 2. Prevent Screen Sleep (Anti-Crash)
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}

            // 3. Connect
            connectMQTT(() => {
                document.getElementById('setup-panel').classList.add('hidden');
                appWrapper.classList.remove('hidden');
                document.getElementById('host-controls').classList.remove('hidden');
                document.getElementById('share-area').classList.remove('hidden');
                
                const link = `${window.location.origin}${window.location.pathname}?join=${roomID}`;
                document.getElementById('invite-link-box').dataset.link = link;
                
                // Unlock Audio
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
        }

        // --- 2. SECURE NETWORK LOGIC (The Logic from OSCE) ---
        function connectMQTT(onSuccess) {
            const clientId = (isHost ? "host_" : "view_") + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(MQTT_BROKER, MQTT_PORT, MQTT_PATH, clientId);

            client.onConnectionLost = (responseObject) => {
                updateStatus(false, "Reconnecting...");
                setTimeout(() => connectMQTT(onSuccess), 2500);
            };

            client.onMessageArrived = (message) => {
                try {
                    const data = JSON.parse(message.payloadString);
                    handleData(data);
                } catch (e) { console.error(e); }
            };

            // CONNECT WITH SSL (Bypasses Firewall)
            client.connect({
                useSSL: true,
                timeout: 5,
                keepAliveInterval: 30,
                onSuccess: () => {
                    updateStatus(true, "Securely Connected");
                    client.subscribe(`timerapp/${roomID}/state`);
                    if (onSuccess) onSuccess();
                },
                onFailure: (e) => {
                    updateStatus(false, "Connection Failed");
                    setTimeout(() => connectMQTT(onSuccess), 5000);
                }
            });
        }

        function publishState() {
            if (!isHost || !client || !client.isConnected()) return;
            
            const payload = {
                targetTime: targetTime
            };

            const message = new Paho.MQTT.Message(JSON.stringify(payload));
            message.destinationName = `timerapp/${roomID}/state`;
            message.retained = true; // Crucial: New viewers get time instantly
            client.send(message);
        }

        // --- 3. TIMER LOGIC ---
        function handleData(data) {
            // Only update targetTime if it changes
            if (data.targetTime !== targetTime) {
                targetTime = data.targetTime;
                // If adding time, reset flags
                if (targetTime && targetTime > Date.now()) {
                    hasWarned = false; hasEnded = false;
                    applyColor(currentTheme.bg, currentTheme.text);
                }
                updateDisplay();
            }
        }

        function addTime(minutes) {
            if (!isHost) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();

            const now = Date.now();
            // Start from existing target if running, else start from now
            const basis = (targetTime && targetTime > now) ? targetTime : now;
            targetTime = basis + (minutes * 60 * 1000);
            
            hasWarned = false; hasEnded = false;
            publishState();
            updateDisplay();
        }

        function resetTimer() {
            if (!isHost) return;
            targetTime = null;
            hasWarned = false; hasEnded = false;
            applyColor(currentTheme.bg, currentTheme.text);
            publishState();
            updateDisplay();
        }

        function updateDisplay() {
            if (!targetTime) {
                displayEl.innerText = "00:00";
                return;
            }

            const now = Date.now();
            const diff = targetTime - now;

            if (diff <= 0) {
                // FINISHED
                displayEl.innerText = "00:00";
                if (!hasEnded) {
                    hasEnded = true;
                    applyColor('var(--end-bg)', 'var(--end-text)'); // RED
                    playSound('alarm');
                }
            } else if (diff <= 60000) {
                // WARNING (< 1 MIN)
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                displayEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                
                if (!hasWarned) {
                    hasWarned = true;
                    applyColor('var(--warn-bg)', 'var(--warn-text)'); // ORANGE
                    playSound('beep');
                }
            } else {
                // NORMAL
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                displayEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                
                // Revert color if we added time
                if (hasWarned) {
                    hasWarned = false;
                    applyColor(currentTheme.bg, currentTheme.text);
                }
            }
        }
        
        // High-speed update loop for smoothness
        setInterval(updateDisplay, 50);

        // --- 4. UTILS & UI ---
        function updateStatus(connected, text) {
            const dot = document.getElementById('conn-dot');
            const msg = document.getElementById('status-msg');
            msg.innerText = text;
            dot.style.background = connected ? '#00ff9d' : '#ff4444';
            dot.style.boxShadow = connected ? '0 0 5px #00ff9d' : 'none';
        }

        function applyColor(bg, text) {
            document.body.style.backgroundColor = bg;
            displayEl.style.color = text;
            if (pipWindow) pipWindow.document.body.style.backgroundColor = bg;
        }

        window.setTheme = (name) => {
            currentTheme = themes[name];
            if (!hasWarned && !hasEnded) applyColor(currentTheme.bg, currentTheme.text);
        };

        window.toggleSettings = () => document.getElementById('settings-panel').classList.toggle('hidden');

        window.toggleSound = () => {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').innerText = soundEnabled ? "ðŸ”Š" : "ðŸ”‡";
            if (soundEnabled && audioCtx.state === 'suspended') audioCtx.resume();
        };

        window.copyLink = () => {
            const link = document.getElementById('invite-link-box').dataset.link;
            if(link) { navigator.clipboard.writeText(link); alert("Link copied!"); }
        };

        // --- 5. AUDIO ENGINE ---
        function playSound(type) {
            if (!soundEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;

            if (type === 'beep') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.1, now); 
                gain.gain.setValueAtTime(0, now + 0.1); // blip
                gain.gain.setValueAtTime(0.1, now + 0.2); 
                gain.gain.setValueAtTime(0, now + 0.3); // blip
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'alarm') {
                osc.type = 'square'; osc.frequency.setValueAtTime(600, now);
                gain.gain.setValueAtTime(0.1, now); 
                gain.gain.setValueAtTime(0, now + 0.2);
                gain.gain.setValueAtTime(0.1, now + 0.3); 
                gain.gain.setValueAtTime(0, now + 0.5);
                gain.gain.linearRampToValueAtTime(0, now + 1.2);
                osc.start(now); osc.stop(now + 1.2);
            }
        }

        // --- 6. POP OUT (PiP) ---
        window.togglePiP = async () => {
            if (!('documentPictureInPicture' in window)) return alert("Use Chrome/Edge");
            if (pipWindow) { pipWindow.close(); return; }

            pipWindow = await window.documentPictureInPicture.requestWindow({ width: 300, height: 150 });
            
            // Clone Styles
            [...document.head.querySelectorAll('style, link[rel="stylesheet"]')].forEach(el => {
                pipWindow.document.head.appendChild(el.cloneNode(true));
            });

            const currentBg = document.body.style.backgroundColor || currentTheme.bg;
            pipWindow.document.body.style.backgroundColor = currentBg;
            Object.assign(pipWindow.document.body.style, {
                display: "flex", alignItems: "center", justifyContent: "center",
                margin: "0", height: "100vh", overflow: "hidden", 
                transition: "background-color 0.5s ease"
            });

            pipWindow.document.body.append(displayEl);
            displayEl.style.fontSize = "40vh"; 

            pipWindow.addEventListener('pagehide', () => {
                displayEl.style.fontSize = "25vw";
                appWrapper.insertBefore(displayEl, uiContainer);
                pipWindow = null;
            });
        };
    </script>
</body>
</html>
